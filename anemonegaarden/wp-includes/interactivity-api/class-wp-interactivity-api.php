<?php
 final class WP_Interactivity_API { private static $directive_processors = array( 'data-wp-interactive' => 'data_wp_interactive_processor', 'data-wp-router-region' => 'data_wp_router_region_processor', 'data-wp-context' => 'data_wp_context_processor', 'data-wp-bind' => 'data_wp_bind_processor', 'data-wp-class' => 'data_wp_class_processor', 'data-wp-style' => 'data_wp_style_processor', 'data-wp-text' => 'data_wp_text_processor', 'data-wp-each' => 'data_wp_each_processor', ); private $state_data = array(); private $config_data = array(); private $derived_state_closures = array(); private $has_processed_router_region = false; private $script_modules_that_can_load_on_client_navigation = array(); private $namespace_stack = null; private $context_stack = null; private $current_element = null; public function state( ?string $store_namespace = null, ?array $state = null ): array { if ( ! $store_namespace ) { if ( $state ) { _doing_it_wrong( __METHOD__, __( 'The namespace is required when state data is passed.' ), '6.6.0' ); return array(); } if ( null !== $store_namespace ) { _doing_it_wrong( __METHOD__, __( 'The namespace should be a non-empty string.' ), '6.6.0' ); return array(); } if ( null === $this->namespace_stack ) { _doing_it_wrong( __METHOD__, __( 'The namespace can only be omitted during directive processing.' ), '6.6.0' ); return array(); } $store_namespace = end( $this->namespace_stack ); } if ( ! isset( $this->state_data[ $store_namespace ] ) ) { $this->state_data[ $store_namespace ] = array(); } if ( is_array( $state ) ) { $this->state_data[ $store_namespace ] = array_replace_recursive( $this->state_data[ $store_namespace ], $state ); } return $this->state_data[ $store_namespace ]; } public function config( string $store_namespace, array $config = array() ): array { if ( ! isset( $this->config_data[ $store_namespace ] ) ) { $this->config_data[ $store_namespace ] = array(); } if ( is_array( $config ) ) { $this->config_data[ $store_namespace ] = array_replace_recursive( $this->config_data[ $store_namespace ], $config ); } return $this->config_data[ $store_namespace ]; } public function print_client_interactivity_data() { _deprecated_function( __METHOD__, '6.7.0' ); } public function filter_script_module_interactivity_router_data( array $data ): array { if ( ! isset( $data['i18n'] ) ) { $data['i18n'] = array(); } $data['i18n']['loading'] = __( 'Loading page, please wait.' ); $data['i18n']['loaded'] = __( 'Page Loaded.' ); return $data; } public function filter_script_module_interactivity_data( array $data ): array { if ( empty( $this->state_data ) && empty( $this->config_data ) && empty( $this->derived_state_closures ) ) { return $data; } $config = array(); foreach ( $this->config_data as $key => $value ) { if ( ! empty( $value ) ) { $config[ $key ] = $value; } } if ( ! empty( $config ) ) { $data['config'] = $config; } $state = array(); foreach ( $this->state_data as $key => $value ) { if ( ! empty( $value ) ) { $state[ $key ] = $value; } } if ( ! empty( $state ) ) { $data['state'] = $state; } $derived_props = array(); foreach ( $this->derived_state_closures as $key => $value ) { if ( ! empty( $value ) ) { $derived_props[ $key ] = $value; } } if ( ! empty( $derived_props ) ) { $data['derivedStateClosures'] = $derived_props; } return $data; } public function get_context( ?string $store_namespace = null ): array { if ( null === $this->context_stack ) { _doing_it_wrong( __METHOD__, __( 'The context can only be read during directive processing.' ), '6.6.0' ); return array(); } if ( ! $store_namespace ) { if ( null !== $store_namespace ) { _doing_it_wrong( __METHOD__, __( 'The namespace should be a non-empty string.' ), '6.6.0' ); return array(); } $store_namespace = end( $this->namespace_stack ); } $context = end( $this->context_stack ); return ( $store_namespace && $context && isset( $context[ $store_namespace ] ) ) ? $context[ $store_namespace ] : array(); } public function get_element(): ?array { if ( null === $this->current_element ) { _doing_it_wrong( __METHOD__, __( 'The element can only be read during directive processing.' ), '6.7.0' ); } return $this->current_element; } public function register_script_modules() { _deprecated_function( __METHOD__, '6.7.0', 'wp_default_script_modules' ); } public function add_hooks() { add_filter( 'script_module_data_@wordpress/interactivity', array( $this, 'filter_script_module_interactivity_data' ) ); add_filter( 'script_module_data_@wordpress/interactivity-router', array( $this, 'filter_script_module_interactivity_router_data' ) ); add_filter( 'wp_script_attributes', array( $this, 'add_load_on_client_navigation_attribute_to_script_modules' ), 10, 1 ); } public function add_load_on_client_navigation_attribute_to_script_modules( $attributes ) { if ( is_array( $attributes ) && isset( $attributes['type'], $attributes['id'] ) && 'module' === $attributes['type'] && array_key_exists( preg_replace( '/-js-module$/', '', $attributes['id'] ), $this->script_modules_that_can_load_on_client_navigation ) ) { $attributes['data-wp-router-options'] = wp_json_encode( array( 'loadOnClientNavigation' => true ) ); } return $attributes; } public function add_client_navigation_support_to_script_module( string $script_module_id ) { $this->script_modules_that_can_load_on_client_navigation[ $script_module_id ] = true; } public function process_directives( string $html ): string { if ( ! str_contains( $html, 'data-wp-' ) ) { return $html; } $this->namespace_stack = array(); $this->context_stack = array(); $result = $this->_process_directives( $html ); $this->namespace_stack = null; $this->context_stack = null; return null === $result ? $html : $result; } private function _process_directives( string $html ) { $p = new WP_Interactivity_API_Directives_Processor( $html ); $tag_stack = array(); $unbalanced = false; $directive_processor_prefixes = array_keys( self::$directive_processors ); $directive_processor_prefixes_reversed = array_reverse( $directive_processor_prefixes ); $namespace_stack_size = count( $this->namespace_stack ); $context_stack_size = count( $this->context_stack ); while ( $p->next_tag( array( 'tag_closers' => 'visit' ) ) ) { $tag_name = $p->get_tag(); if ( 'SVG' === $tag_name || 'MATH' === $tag_name ) { if ( $p->get_attribute_names_with_prefix( 'data-wp-' ) ) { $message = sprintf( __( 'Interactivity directives were detected on an incompatible %1$s tag when processing "%2$s". These directives will be ignored in the server side render.' ), $tag_name, end( $this->namespace_stack ) ); _doing_it_wrong( __METHOD__, $message, '6.6.0' ); } $p->skip_to_tag_closer(); continue; } if ( $p->is_tag_closer() ) { list( $opening_tag_name, $directives_prefixes ) = ! empty( $tag_stack ) ? end( $tag_stack ) : array( null, null ); if ( 0 === count( $tag_stack ) || $opening_tag_name !== $tag_name ) { $unbalanced = true; break; } else { array_pop( $tag_stack ); } } else { $each_child_attrs = $p->get_attribute_names_with_prefix( 'data-wp-each-child' ); if ( null === $each_child_attrs ) { continue; } if ( 0 !== count( $each_child_attrs ) ) { $p->next_balanced_tag_closer_tag(); continue; } else { $directives_prefixes = array(); foreach ( $p->get_attribute_names_with_prefix( 'data-wp-' ) as $attribute_name ) { $parsed_directive = $this->parse_directive_name( $attribute_name ); if ( empty( $parsed_directive ) ) { continue; } $directive_prefix = 'data-wp-' . $parsed_directive['prefix']; if ( array_key_exists( $directive_prefix, self::$directive_processors ) ) { $directives_prefixes[] = $directive_prefix; } } if ( $p->has_and_visits_its_closer_tag() ) { $tag_stack[] = array( $tag_name, $directives_prefixes ); } } } if ( 0 === count( $directives_prefixes ) ) { continue; } $modes = array( 'enter' => ! $p->is_tag_closer(), 'exit' => $p->is_tag_closer() || ! $p->has_and_visits_its_closer_tag(), ); $element_attrs = array(); $attr_names = $p->get_attribute_names_with_prefix( '' ) ?? array(); foreach ( $attr_names as $name ) { $element_attrs[ $name ] = $p->get_attribute( $name ); } $this->current_element = array( 'attributes' => $element_attrs, ); foreach ( $modes as $mode => $should_run ) { if ( ! $should_run ) { continue; } $existing_directives_prefixes = array_intersect( 'enter' === $mode ? $directive_processor_prefixes : $directive_processor_prefixes_reversed, $directives_prefixes ); foreach ( $existing_directives_prefixes as $directive_prefix ) { $func = is_array( self::$directive_processors[ $directive_prefix ] ) ? self::$directive_processors[ $directive_prefix ] : array( $this, self::$directive_processors[ $directive_prefix ] ); call_user_func_array( $func, array( $p, $mode, &$tag_stack ) ); } } $this->current_element = null; } if ( $unbalanced ) { array_splice( $this->namespace_stack, $namespace_stack_size ); array_splice( $this->context_stack, $context_stack_size ); } if ( $unbalanced || 0 < count( $tag_stack ) ) { return null; } return $p->get_updated_html(); } private function evaluate( $entry ) { $context = end( $this->context_stack ); ['namespace' => $ns, 'value' => $path] = $entry; if ( ! $ns || ! $path ) { $message = sprintf( __( 'Namespace or reference path cannot be empty. Directive value referenced: %s' ), json_encode( $entry ) ); _doing_it_wrong( __METHOD__, $message, '6.6.0' ); return null; } $store = array( 'state' => $this->state_data[ $ns ] ?? array(), 'context' => $context[ $ns ] ?? array(), ); $should_negate_value = '!' === $path[0]; $path = $should_negate_value ? substr( $path, 1 ) : $path; $path_segments = explode( '.', $path ); $current = $store; foreach ( $path_segments as $index => $path_segment ) { if ( 'length' === $path_segment ) { if ( is_array( $current ) && array_is_list( $current ) ) { $current = count( $current ); break; } if ( is_string( $current ) ) { $current = strlen( $current ); break; } } if ( ( is_array( $current ) || $current instanceof ArrayAccess ) && isset( $current[ $path_segment ] ) ) { $current = $current[ $path_segment ]; } elseif ( is_object( $current ) && isset( $current->$path_segment ) ) { $current = $current->$path_segment; } else { $current = null; break; } if ( $current instanceof Closure ) { array_push( $this->namespace_stack, $ns ); try { $current = $current(); $this->derived_state_closures[ $ns ] = $this->derived_state_closures[ $ns ] ?? array(); $current_path = implode( '.', array_slice( $path_segments, 0, $index + 1 ) ); if ( ! in_array( $current_path, $this->derived_state_closures[ $ns ], true ) ) { $this->derived_state_closures[ $ns ][] = $current_path; } } catch ( Throwable $e ) { _doing_it_wrong( __METHOD__, sprintf( __( 'Uncaught error executing a derived state callback with path "%1$s" and namespace "%2$s".' ), $path, $ns ), '6.6.0' ); return null; } finally { array_pop( $this->namespace_stack ); } } } return $should_negate_value ? ! $current : $current; } private function parse_directive_name( string $directive_name ): ?array { $name = substr( $directive_name, 8 ); if ( preg_match( '/[^a-z0-9\-_]/i', $name ) ) { return null; } $suffix_index = strpos( $name, '--' ); if ( false === $suffix_index ) { return array( 'prefix' => $name, 'suffix' => null, 'unique_id' => null, ); } $prefix = substr( $name, 0, $suffix_index ); $remaining = substr( $name, $suffix_index ); if ( '---' === substr( $remaining, 0, 3 ) && '-' !== ( $remaining[3] ?? '' ) ) { return array( 'prefix' => $prefix, 'suffix' => null, 'unique_id' => '---' !== $remaining ? substr( $remaining, 3 ) : null, ); } $suffix = substr( $remaining, 2 ); $unique_id_index = strpos( $suffix, '---' ); if ( false !== $unique_id_index && '-' !== ( $suffix[ $unique_id_index + 3 ] ?? '' ) ) { $unique_id = substr( $suffix, $unique_id_index + 3 ); $suffix = substr( $suffix, 0, $unique_id_index ); return array( 'prefix' => $prefix, 'suffix' => empty( $suffix ) ? null : $suffix, 'unique_id' => empty( $unique_id ) ? null : $unique_id, ); } return array( 'prefix' => $prefix, 'suffix' => empty( $suffix ) ? null : $suffix, 'unique_id' => null, ); } private function extract_directive_value( $directive_value, $default_namespace = null ): array { if ( empty( $directive_value ) || is_bool( $directive_value ) ) { return array( $default_namespace, null ); } if ( 1 === preg_match( '/^([\w\-_\/]+)::./', $directive_value ) ) { list($default_namespace, $directive_value) = explode( '::', $directive_value, 2 ); } $decoded_json = json_decode( $directive_value, true ); if ( null !== $decoded_json || 'null' === $directive_value ) { $directive_value = $decoded_json; } return array( $default_namespace, $directive_value ); } private function get_directive_entries( WP_Interactivity_API_Directives_Processor $p, string $prefix ) { $directive_attributes = $p->get_attribute_names_with_prefix( 'data-wp-' . $prefix ); $entries = array(); foreach ( $directive_attributes as $attribute_name ) { [ 'prefix' => $attr_prefix, 'suffix' => $suffix, 'unique_id' => $unique_id] = $this->parse_directive_name( $attribute_name ); if ( $prefix !== $attr_prefix ) { continue; } list( $namespace, $value ) = $this->extract_directive_value( $p->get_attribute( $attribute_name ), end( $this->namespace_stack ) ); $entries[] = array( 'namespace' => $namespace, 'value' => $value, 'suffix' => $suffix, 'unique_id' => $unique_id, ); } usort( $entries, function ( $a, $b ) { $a_suffix = $a['suffix'] ?? ''; $b_suffix = $b['suffix'] ?? ''; if ( $a_suffix !== $b_suffix ) { return $a_suffix < $b_suffix ? -1 : 1; } $a_id = $a['unique_id'] ?? ''; $b_id = $b['unique_id'] ?? ''; if ( $a_id === $b_id ) { return 0; } return $a_id > $b_id ? 1 : -1; } ); return $entries; } private function kebab_to_camel_case( string $str ): string { return lcfirst( preg_replace_callback( '/(-)([a-z])/', function ( $matches ) { return strtoupper( $matches[2] ); }, strtolower( rtrim( $str, '-' ) ) ) ); } private function data_wp_interactive_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'exit' === $mode ) { array_pop( $this->namespace_stack ); return; } $attribute_value = $p->get_attribute( 'data-wp-interactive' ); $new_namespace = null; if ( is_string( $attribute_value ) && ! empty( $attribute_value ) ) { $decoded_json = json_decode( $attribute_value, true ); if ( is_array( $decoded_json ) ) { $new_namespace = $decoded_json['namespace'] ?? null; } else { $new_namespace = $attribute_value; } } $this->namespace_stack[] = ( $new_namespace && 1 === preg_match( '/^([\w\-_\/]+)/', $new_namespace ) ) ? $new_namespace : end( $this->namespace_stack ); } private function data_wp_context_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'exit' === $mode ) { array_pop( $this->context_stack ); return; } $entries = $this->get_directive_entries( $p, 'context' ); $context = end( $this->context_stack ) !== false ? end( $this->context_stack ) : array(); foreach ( $entries as $entry ) { if ( null !== $entry['suffix'] ) { continue; } $context = array_replace_recursive( $context, array( $entry['namespace'] => is_array( $entry['value'] ) ? $entry['value'] : array() ) ); } $this->context_stack[] = $context; } private function data_wp_bind_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'enter' === $mode ) { $entries = $this->get_directive_entries( $p, 'bind' ); foreach ( $entries as $entry ) { if ( empty( $entry['suffix'] ) || null !== $entry['unique_id'] ) { return; } $result = $this->evaluate( $entry ); if ( null !== $result && ( false !== $result || ( strlen( $entry['suffix'] ) > 5 && '-' === $entry['suffix'][4] ) ) ) { if ( is_bool( $result ) && ( strlen( $entry['suffix'] ) > 5 && '-' === $entry['suffix'][4] ) ) { $result = $result ? 'true' : 'false'; } $p->set_attribute( $entry['suffix'], $result ); } else { $p->remove_attribute( $entry['suffix'] ); } } } } private function data_wp_class_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'enter' === $mode ) { $all_class_directives = $p->get_attribute_names_with_prefix( 'data-wp-class--' ); $entries = $this->get_directive_entries( $p, 'class' ); foreach ( $entries as $entry ) { if ( empty( $entry['suffix'] ) ) { continue; } $class_name = isset( $entry['unique_id'] ) && $entry['unique_id'] ? "{$entry['suffix']}---{$entry['unique_id']}" : $entry['suffix']; if ( empty( $class_name ) ) { return; } $result = $this->evaluate( $entry ); if ( $result ) { $p->add_class( $class_name ); } else { $p->remove_class( $class_name ); } } } } private function data_wp_style_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'enter' === $mode ) { $entries = $this->get_directive_entries( $p, 'style' ); foreach ( $entries as $entry ) { $style_property = $entry['suffix']; if ( empty( $style_property ) || null !== $entry['unique_id'] ) { continue; } $style_property_value = $this->evaluate( $entry ); $style_attribute_value = $p->get_attribute( 'style' ); $style_attribute_value = ( $style_attribute_value && ! is_bool( $style_attribute_value ) ) ? $style_attribute_value : ''; if ( $style_property_value || $style_attribute_value ) { $style_attribute_value = $this->merge_style_property( $style_attribute_value, $style_property, $style_property_value ); if ( ! empty( $style_attribute_value ) ) { $p->set_attribute( 'style', $style_attribute_value ); } else { $p->remove_attribute( 'style' ); } } } } } private function merge_style_property( string $style_attribute_value, string $style_property_name, $style_property_value ): string { $style_assignments = explode( ';', $style_attribute_value ); $result = array(); $style_property_value = ! empty( $style_property_value ) ? rtrim( trim( $style_property_value ), ';' ) : null; $new_style_property = $style_property_value ? $style_property_name . ':' . $style_property_value . ';' : ''; foreach ( $style_assignments as $style_assignment ) { if ( empty( trim( $style_assignment ) ) ) { continue; } list( $name, $value ) = explode( ':', $style_assignment ); if ( trim( $name ) !== $style_property_name ) { $result[] = trim( $name ) . ':' . trim( $value ) . ';'; } } $result[] = $new_style_property; return implode( '', $result ); } private function data_wp_text_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'enter' === $mode ) { $entries = $this->get_directive_entries( $p, 'text' ); $valid_entry = null; foreach ( $entries as $entry ) { if ( null === $entry['suffix'] && null === $entry['unique_id'] && ! empty( $entry['value'] ) ) { $valid_entry = $entry; break; } } if ( null === $valid_entry ) { return; } $result = $this->evaluate( $valid_entry ); if ( is_string( $result ) || is_numeric( $result ) ) { $p->set_content_between_balanced_tags( esc_html( $result ) ); } else { $p->set_content_between_balanced_tags( '' ); } } } private function get_router_animation_styles(): string { return <<<CSS
			.wp-interactivity-router-loading-bar {
				position: fixed;
				top: 0;
				left: 0;
				margin: 0;
				padding: 0;
				width: 100vw;
				max-width: 100vw !important;
				height: 4px;
				background-color: #000;
				opacity: 0
			}
			.wp-interactivity-router-loading-bar.start-animation {
				animation: wp-interactivity-router-loading-bar-start-animation 30s cubic-bezier(0.03, 0.5, 0, 1) forwards
			}
			.wp-interactivity-router-loading-bar.finish-animation {
				animation: wp-interactivity-router-loading-bar-finish-animation 300ms ease-in
			}
			@keyframes wp-interactivity-router-loading-bar-start-animation {
				0% { transform: scaleX(0); transform-origin: 0 0; opacity: 1 }
				100% { transform: scaleX(1); transform-origin: 0 0; opacity: 1 }
			}
			@keyframes wp-interactivity-router-loading-bar-finish-animation {
				0% { opacity: 1 }
				50% { opacity: 1 }
				100% { opacity: 0 }
			}
CSS;
} public function print_router_loading_and_screen_reader_markup() { _deprecated_function( __METHOD__, '6.7.0', 'WP_Interactivity_API::print_router_markup' ); $this->print_router_markup(); } public function print_router_markup() { echo <<<HTML
			<div
				class="wp-interactivity-router-loading-bar"
				data-wp-interactive="core/router"
				data-wp-class--start-animation="state.navigation.hasStarted"
				data-wp-class--finish-animation="state.navigation.hasFinished"
			></div>
HTML;
} private function data_wp_router_region_processor( WP_Interactivity_API_Directives_Processor $p, string $mode ) { if ( 'enter' === $mode && ! $this->has_processed_router_region ) { $this->has_processed_router_region = true; wp_register_style( 'wp-interactivity-router-animations', false ); wp_add_inline_style( 'wp-interactivity-router-animations', $this->get_router_animation_styles() ); wp_enqueue_style( 'wp-interactivity-router-animations' ); add_action( 'wp_footer', array( $this, 'print_router_markup' ) ); } } private function data_wp_each_processor( WP_Interactivity_API_Directives_Processor $p, string $mode, array &$tag_stack ) { if ( 'enter' === $mode && 'TEMPLATE' === $p->get_tag() ) { $entries = $this->get_directive_entries( $p, 'each' ); if ( count( $entries ) > 1 || empty( $entries ) ) { return; } $entry = $entries[0]; if ( null !== $entry['unique_id'] ) { return; } $item_name = isset( $entry['suffix'] ) ? $this->kebab_to_camel_case( $entry['suffix'] ) : 'item'; $result = $this->evaluate( $entry ); $inner_content = $p->get_content_between_balanced_template_tags(); $template_end = 'data-wp-each: template end'; $p->set_bookmark( $template_end ); $p->next_tag(); $manual_sdp = $p->get_attribute( 'data-wp-each-child' ); $p->seek( $template_end ); $p->release_bookmark( $template_end ); if ( $manual_sdp || empty( $result ) || ! is_array( $result ) || ! array_is_list( $result ) || ! str_starts_with( trim( $inner_content ), '<' ) || ! str_ends_with( trim( $inner_content ), '>' ) ) { array_pop( $tag_stack ); return; } $processed_content = ''; foreach ( $result as $item ) { $this->context_stack[] = array_replace_recursive( end( $this->context_stack ) !== false ? end( $this->context_stack ) : array(), array( $entry['namespace'] => array( $item_name => $item ) ) ); $processed_item = $this->_process_directives( $inner_content ); if ( null === $processed_item ) { array_pop( $this->context_stack ); return; } $i = new WP_Interactivity_API_Directives_Processor( $processed_item ); while ( $i->next_tag() ) { $i->set_attribute( 'data-wp-each-child', $entry['namespace'] . '::' . $entry['value'] ); $i->next_balanced_tag_closer_tag(); } $processed_content .= $i->get_updated_html(); array_pop( $this->context_stack ); } $p->append_content_after_template_tag_closer( $processed_content ); array_pop( $tag_stack ); } } } 