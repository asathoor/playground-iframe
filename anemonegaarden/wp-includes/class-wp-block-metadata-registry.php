<?php
 class WP_Block_Metadata_Registry { private static $collections = array(); private static $last_matched_collection = null; private static $default_collection_roots = null; public static function register_collection( $path, $manifest ) { $path = rtrim( wp_normalize_path( $path ), '/' ); $collection_roots = self::get_default_collection_roots(); $collection_roots = apply_filters( 'wp_allowed_block_metadata_collection_roots', $collection_roots ); $collection_roots = array_unique( array_map( static function ( $allowed_root ) { return rtrim( wp_normalize_path( $allowed_root ), '/' ); }, $collection_roots ) ); if ( ! self::is_valid_collection_path( $path, $collection_roots ) ) { _doing_it_wrong( __METHOD__, sprintf( __( 'Block metadata collections cannot be registered as one of the following directories or their parent directories: %s' ), esc_html( implode( wp_get_list_item_separator(), $collection_roots ) ) ), '6.7.2' ); return false; } if ( ! file_exists( $manifest ) ) { _doing_it_wrong( __METHOD__, __( 'The specified manifest file does not exist.' ), '6.7.0' ); return false; } self::$collections[ $path ] = array( 'manifest' => $manifest, 'metadata' => null, ); return true; } public static function get_metadata( $file_or_folder ) { $file_or_folder = wp_normalize_path( $file_or_folder ); $path = self::find_collection_path( $file_or_folder ); if ( ! $path ) { return null; } $collection = &self::$collections[ $path ]; if ( null === $collection['metadata'] ) { $collection['metadata'] = require $collection['manifest']; } $block_name = self::default_identifier_callback( $file_or_folder ); return isset( $collection['metadata'][ $block_name ] ) ? $collection['metadata'][ $block_name ] : null; } public static function get_collection_block_metadata_files( $path ) { $path = rtrim( wp_normalize_path( $path ), '/' ); if ( ! isset( self::$collections[ $path ] ) ) { _doing_it_wrong( __METHOD__, __( 'No registered block metadata collection was found for the provided path.' ), '6.8.0' ); return array(); } $collection = &self::$collections[ $path ]; if ( null === $collection['metadata'] ) { $collection['metadata'] = require $collection['manifest']; } return array_map( static function ( $block_name ) use ( $path ) { return "{$path}/{$block_name}/block.json"; }, array_keys( $collection['metadata'] ) ); } private static function find_collection_path( $file_or_folder ) { if ( empty( $file_or_folder ) ) { return null; } $path = rtrim( $file_or_folder, '/' ); if ( self::$last_matched_collection && str_starts_with( $path, self::$last_matched_collection ) ) { return self::$last_matched_collection; } $collection_paths = array_keys( self::$collections ); foreach ( $collection_paths as $collection_path ) { if ( str_starts_with( $path, $collection_path ) ) { self::$last_matched_collection = $collection_path; return $collection_path; } } return null; } public static function has_metadata( $file_or_folder ) { return null !== self::get_metadata( $file_or_folder ); } private static function default_identifier_callback( $path ) { if ( empty( $path ) ) { return ''; } if ( str_ends_with( $path, 'block.json' ) ) { return basename( dirname( $path ) ); } return basename( $path ); } private static function is_valid_collection_path( $path, $collection_roots ) { foreach ( $collection_roots as $allowed_root ) { if ( $allowed_root === $path ) { return false; } if ( str_starts_with( $allowed_root, $path ) ) { return false; } } return true; } private static function get_default_collection_roots() { if ( isset( self::$default_collection_roots ) ) { return self::$default_collection_roots; } $collection_roots = array( wp_normalize_path( ABSPATH . WPINC ), wp_normalize_path( WP_CONTENT_DIR ), wp_normalize_path( WPMU_PLUGIN_DIR ), wp_normalize_path( WP_PLUGIN_DIR ), ); $theme_roots = get_theme_roots(); if ( ! is_array( $theme_roots ) ) { $theme_roots = array( $theme_roots ); } foreach ( $theme_roots as $theme_root ) { $collection_roots[] = trailingslashit( wp_normalize_path( WP_CONTENT_DIR ) ) . ltrim( wp_normalize_path( $theme_root ), '/' ); } self::$default_collection_roots = array_unique( $collection_roots ); return self::$default_collection_roots; } } 