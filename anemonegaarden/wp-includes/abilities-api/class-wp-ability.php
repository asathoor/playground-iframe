<?php
 declare( strict_types = 1 ); class WP_Ability { protected const DEFAULT_SHOW_IN_REST = false; protected static $default_annotations = array( 'readonly' => null, 'destructive' => null, 'idempotent' => null, ); protected $name; protected $label; protected $description; protected $category; protected $input_schema = array(); protected $output_schema = array(); protected $execute_callback; protected $permission_callback; protected $meta; public function __construct( string $name, array $args ) { $this->name = $name; $properties = $this->prepare_properties( $args ); foreach ( $properties as $property_name => $property_value ) { if ( ! property_exists( $this, $property_name ) ) { _doing_it_wrong( __METHOD__, sprintf( __( 'Property "%1$s" is not a valid property for ability "%2$s". Please check the %3$s class for allowed properties.' ), '<code>' . esc_html( $property_name ) . '</code>', '<code>' . esc_html( $this->name ) . '</code>', '<code>' . __CLASS__ . '</code>' ), '6.9.0' ); continue; } $this->$property_name = $property_value; } } protected function prepare_properties( array $args ): array { if ( empty( $args['label'] ) || ! is_string( $args['label'] ) ) { throw new InvalidArgumentException( __( 'The ability properties must contain a `label` string.' ) ); } if ( empty( $args['description'] ) || ! is_string( $args['description'] ) ) { throw new InvalidArgumentException( __( 'The ability properties must contain a `description` string.' ) ); } if ( empty( $args['category'] ) || ! is_string( $args['category'] ) ) { throw new InvalidArgumentException( __( 'The ability properties must contain a `category` string.' ) ); } if ( empty( $args['execute_callback'] ) || ! is_callable( $args['execute_callback'] ) ) { throw new InvalidArgumentException( __( 'The ability properties must contain a valid `execute_callback` function.' ) ); } if ( empty( $args['permission_callback'] ) || ! is_callable( $args['permission_callback'] ) ) { throw new InvalidArgumentException( __( 'The ability properties must provide a valid `permission_callback` function.' ) ); } if ( isset( $args['input_schema'] ) && ! is_array( $args['input_schema'] ) ) { throw new InvalidArgumentException( __( 'The ability properties should provide a valid `input_schema` definition.' ) ); } if ( isset( $args['output_schema'] ) && ! is_array( $args['output_schema'] ) ) { throw new InvalidArgumentException( __( 'The ability properties should provide a valid `output_schema` definition.' ) ); } if ( isset( $args['meta'] ) && ! is_array( $args['meta'] ) ) { throw new InvalidArgumentException( __( 'The ability properties should provide a valid `meta` array.' ) ); } if ( isset( $args['meta']['annotations'] ) && ! is_array( $args['meta']['annotations'] ) ) { throw new InvalidArgumentException( __( 'The ability meta should provide a valid `annotations` array.' ) ); } if ( isset( $args['meta']['show_in_rest'] ) && ! is_bool( $args['meta']['show_in_rest'] ) ) { throw new InvalidArgumentException( __( 'The ability meta should provide a valid `show_in_rest` boolean.' ) ); } $args['meta'] = wp_parse_args( $args['meta'] ?? array(), array( 'annotations' => static::$default_annotations, 'show_in_rest' => self::DEFAULT_SHOW_IN_REST, ) ); $args['meta']['annotations'] = wp_parse_args( $args['meta']['annotations'], static::$default_annotations ); return $args; } public function get_name(): string { return $this->name; } public function get_label(): string { return $this->label; } public function get_description(): string { return $this->description; } public function get_category(): string { return $this->category; } public function get_input_schema(): array { return $this->input_schema; } public function get_output_schema(): array { return $this->output_schema; } public function get_meta(): array { return $this->meta; } public function get_meta_item( string $key, $default_value = null ) { return array_key_exists( $key, $this->meta ) ? $this->meta[ $key ] : $default_value; } public function normalize_input( $input = null ) { if ( null !== $input ) { return $input; } $input_schema = $this->get_input_schema(); if ( ! empty( $input_schema ) && array_key_exists( 'default', $input_schema ) ) { return $input_schema['default']; } return null; } public function validate_input( $input = null ) { $input_schema = $this->get_input_schema(); if ( empty( $input_schema ) ) { if ( null === $input ) { return true; } return new WP_Error( 'ability_missing_input_schema', sprintf( __( 'Ability "%s" does not define an input schema required to validate the provided input.' ), esc_html( $this->name ) ) ); } $valid_input = rest_validate_value_from_schema( $input, $input_schema, 'input' ); if ( is_wp_error( $valid_input ) ) { return new WP_Error( 'ability_invalid_input', sprintf( __( 'Ability "%1$s" has invalid input. Reason: %2$s' ), esc_html( $this->name ), $valid_input->get_error_message() ) ); } return true; } protected function invoke_callback( callable $callback, $input = null ) { $args = array(); if ( ! empty( $this->get_input_schema() ) ) { $args[] = $input; } return $callback( ...$args ); } public function check_permissions( $input = null ) { if ( ! is_callable( $this->permission_callback ) ) { return new WP_Error( 'ability_invalid_permission_callback', sprintf( __( 'Ability "%s" does not have a valid permission callback.' ), esc_html( $this->name ) ) ); } return $this->invoke_callback( $this->permission_callback, $input ); } protected function do_execute( $input = null ) { if ( ! is_callable( $this->execute_callback ) ) { return new WP_Error( 'ability_invalid_execute_callback', sprintf( __( 'Ability "%s" does not have a valid execute callback.' ), esc_html( $this->name ) ) ); } return $this->invoke_callback( $this->execute_callback, $input ); } protected function validate_output( $output ) { $output_schema = $this->get_output_schema(); if ( empty( $output_schema ) ) { return true; } $valid_output = rest_validate_value_from_schema( $output, $output_schema, 'output' ); if ( is_wp_error( $valid_output ) ) { return new WP_Error( 'ability_invalid_output', sprintf( __( 'Ability "%1$s" has invalid output. Reason: %2$s' ), esc_html( $this->name ), $valid_output->get_error_message() ) ); } return true; } public function execute( $input = null ) { $input = $this->normalize_input( $input ); $is_valid = $this->validate_input( $input ); if ( is_wp_error( $is_valid ) ) { return $is_valid; } $has_permissions = $this->check_permissions( $input ); if ( true !== $has_permissions ) { if ( is_wp_error( $has_permissions ) ) { _doing_it_wrong( __METHOD__, esc_html( $has_permissions->get_error_message() ), '6.9.0' ); } return new WP_Error( 'ability_invalid_permissions', sprintf( __( 'Ability "%s" does not have necessary permission.' ), esc_html( $this->name ) ) ); } do_action( 'wp_before_execute_ability', $this->name, $input ); $result = $this->do_execute( $input ); if ( is_wp_error( $result ) ) { return $result; } $is_valid = $this->validate_output( $result ); if ( is_wp_error( $is_valid ) ) { return $is_valid; } do_action( 'wp_after_execute_ability', $this->name, $input, $result ); return $result; } public function __wakeup(): void { throw new LogicException( __CLASS__ . ' should never be unserialized.' ); } public function __sleep(): array { throw new LogicException( __CLASS__ . ' should never be serialized.' ); } } 